<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="/ReactJS-Practice-F88/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>B√†i t·∫≠p 6: Weather App</title>
    <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin></script>
    <!-- Babel ƒë·ªÉ bi√™n d·ªãch JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="../../assets/css/main.css" />
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const WEATHER_ID = "fdfd8bff8ab5b53fdd7ca82ef272712e";
      const API_ENDPOINT = {
        TIME_ZONE: "https://worldtimeapi.org/api/ip",
        WEATHER:
          "https://api.openweathermap.org/data/2.5/weather?units=metric&",
      };

      const Header = () => {
        const ToggleTheme = () => {
          const [theme, setTheme] = useState(() => {
            const localTheme = localStorage.getItem("theme");
            return !localTheme ? "dark" : localTheme;
          });

          useEffect(() => {
            document.documentElement.className = theme;
          }, [theme]);

          const toggle = () => {
            const newTheme = theme === "dark" ? "light" : "dark";
            localStorage.setItem("theme", newTheme);
            setTheme(newTheme);
          };

          return (
            <button className="toggle-theme" onClick={toggle}>
              {theme === "dark" ? "üåô" : "‚òÄÔ∏è"}
            </button>
          );
        };

        return (
          <header id="header">
            <div className="header">
              <h1 className="slogan">Conquer ReactJS with F8 üöÄ </h1>
              <a className="gotoback" href="/ReactJS-Practice-F88/index.html">
                Home
              </a>
              <ToggleTheme />
            </div>

            <p className="desc">
              D·∫•u ·∫•n kh√°m ph√° v√† th·ª±c h√†nh ReactJS c√πng F8
              <a href="https://fullstack.edu.vn/">{` - fullstack.edu.vn - `}</a>
              H·ªçc l·∫≠p tr√¨nh ƒë·ªÉ ƒëi l√†m!
            </p>
          </header>
        );
      };

      function Weathers() {
        const [weather, setWeather] = useState([]);
        const [currentCity, setCurrentCity] = useState("");
        const [newCity, setNewCity] = useState("");
        const [error, setError] = useState("");

        useEffect(() => {
          getWeatherLogCity();
        }, []);

        useEffect(() => {
          if (currentCity) {
            getWeatherLogCity(currentCity);
          }
        }, [currentCity]);

        function formatCity(str) {
          return str
            .trim()
            .toLowerCase()
            .replace(/(^|\s)\w/g, (letter) => letter.toUpperCase());
        }

        const getWeatherLogCity = async (desiredCity = null) => {
          const city = desiredCity ? formatCity(desiredCity.trim()) : "Hanoi";
          try {
            const response = await fetch(
              `${API_ENDPOINT.WEATHER}appid=${WEATHER_ID}&q=${city}&lang=vi`,
            );
            const data = await response.json();
            if (data.cod !== 200) {
              setError(`${newCity} City, kh√¥ng c√≥ trong kho d·ªØ li·ªáu!`);
              throw new Error(data.message || "Kh√¥ng t√¨m th·∫•y th√†nh ph·ªë");
            }
            if (!data.sys || !data.weather || !data.main) {
              setError("D·ªØ li·ªáu th·ªùi ti·∫øt kh√¥ng ƒë·∫ßy ƒë·ªß");
              throw new Error("D·ªØ li·ªáu th·ªùi ti·∫øt kh√¥ng ƒë·∫ßy ƒë·ªß");
            }
            const dataWeather = {
              id: data.id,
              city: data.name,
              country: data.sys.country,
              sunrise: formatTime(data.sys.sunrise, data.timezone),
              sunset: formatTime(data.sys.sunset, data.timezone),
              description: data.weather[0].description,
              icon: data.weather[0].icon,
              windDeg: data.wind.deg,
              windGust: data.wind.gust,
              windSpeed: data.wind.speed,
              feels_like: data.main.feels_like,
              humidity: data.main.humidity,
              pressure: data.main.pressure,
              temp: data.main.temp,
              visibility: data.visibility,
              lastUpdated: getCurrentTime(),
            };
            setWeather((prev) => [dataWeather]);
          } catch (error) {
            console.error("Error in getWeatherLogCity: ", error);
          }
        };

        const formatTime = (unixSeconds, tzOffset = 0) => {
          const date = new Date((unixSeconds + tzOffset) * 1000);
          return date.toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
            timeZone: "UTC",
          });
        };

        const getCurrentTime = () => {
          const now = new Date();
          return now.toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        };

        const handleReset = (e) => {
          const target = e.target.closest(".reset");
          if (!target) return;
          const city = target.closest(".weather-card").getAttribute("name");
          getWeatherLogCity(city);
        };

        const handleGetWeather = (e) => {
          const addNewcity = e.target.closest(".add-newcity");
          if (!addNewcity) return;
          if (!newCity && addNewcity) setError("Vui l√≤ng nh·∫≠p t√™n th√†nh ph·ªë!");
          const parents = addNewcity.closest(".weather-input");
          const cityInput = parents.querySelector("#cityInput");

          if (cityInput && newCity) {
            getWeatherLogCity(newCity);
            cityInput.focus();
            setNewCity("");
          }
        };

        const handleInputChange = (e) => {
          const value = e.target.value;
          setNewCity(value.trim());
        };

        const handleInputFocus = () => {
          setError("");
        };

        const handleKeyDown = (e) => {
          if (e.key === "Enter") {
            if (!newCity.trim()) {
              setError("Vui l√≤ng nh·∫≠p t√™n th√†nh ph·ªë!");
              e.target.focus();
              return;
            }
            getWeatherLogCity(newCity);
            setNewCity("");
          }
        };

        const Weather = ({ weather }) => {
          return weather.map((w) => (
            <div key={w.id} name={w.city} id={w.id} className="weather-card">
              <div className="card-head">
                <div className="country">
                  <h2>{w.city}</h2>
                  <p>{w.country}</p>
                </div>
                <div className="quick-info">
                  <div className="temp">{w.temp}¬∞C</div>
                  <div className="description">{w.description}</div>
                </div>
              </div>

              <div className="icon">
                <img
                  src={`http://openweathermap.org/img/wn/${w.icon}@2x.png`}
                  alt="Weather Icon"
                />
              </div>

              <div className="details">
                <div className="humidity-pressure ">
                  <div className="humidity">
                    <div className="label">ƒê·ªô ·∫©m:</div>
                    <div className="value">{w.humidity}%</div>
                  </div>

                  <div className="pressure">
                    <div className="label">√Åp su·∫•t:</div>
                    <div className="value">{w.pressure} hPa</div>
                  </div>
                </div>

                <div className="meta">
                  <p className="feels">
                    C·∫£m gi√°c: {Math.floor(w.feels_like)} ¬∞C
                  </p>
                  <p className="visibility">
                    T·∫ßm nh√¨n: {w.visibility / 1000} km
                  </p>
                </div>

                <div className="wind">
                  <p className="speed">Gi√≥: {w.windSpeed} m/s</p>
                  <p className="gust">Gi√≥ gi·∫≠t: {w.windGust} m/s</p>
                </div>
                <div className="sun">
                  <p>M·∫∑t tr·ªùi m·ªçc: {w.sunrise} </p>
                  <p>M·∫∑t tr·ªùi l·∫∑n: {w.sunset} </p>
                </div>

                <div className="weather-updated">
                  <div className="last-updated">
                    C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: {w.lastUpdated}
                  </div>
                  <div className={`reset`} onClick={handleReset}>
                    <img src="../../reset.svg" alt="reset" />
                  </div>
                </div>
              </div>
            </div>
          ));
        };

        const Loading = () => (
          <div className="loading">
            <svg
              width="250"
              height="250"
              viewBox="0 0 50 50"
              xmlns="http://www.w3.org/2000/svg">
              <circle
                cx="25"
                cy="25"
                r="20"
                stroke="#646cff"
                strokeLinecap="round"
                strokeWidth="2"
                fill="none"
                strokeDasharray="31.4"
                strokeDashoffset="0">
                <animateTransform
                  attributeName="transform"
                  type="rotate"
                  from="0 25 25"
                  to="360 25 25"
                  dur="1s"
                  repeatCount="indefinite"
                />
              </circle>
              <text
                x="25"
                y="25"
                textAnchor="middle"
                dominantBaseline="middle"
                fontSize="6"
                fontWeight="700"
                fill="#646cff">
                Loading‚Ä¶
              </text>
            </svg>
          </div>
        );

        return (
          <div className="container">
            <Header />
            <div className="exercise-content">
              <h2>B√†i t·∫≠p 6: Weather App</h2>

              <a
                href="https://github.com/xuanphao19/ReactJS-Practice-F88/blob/main/public/exercises/exercises_1/weather.html"
                className="repositories">
                Repositories GitHub
              </a>

              <div className="answer-content weather-city">
                {error && (
                  <p className="error">
                    {error}
                    <span onClick={() => setError("")}>‚ùå</span>
                  </p>
                )}
                <div className="list-weather-city">
                  {!weather.length ? (
                    <Loading />
                  ) : (
                    <Weather weather={weather} />
                  )}
                </div>
                <div className="weather-input" onClick={handleGetWeather}>
                  <input
                    onChange={handleInputChange}
                    onKeyDown={handleKeyDown}
                    onFocus={handleInputFocus}
                    type="text"
                    value={newCity}
                    placeholder="Nh·∫≠p th√†nh ph·ªë c·ªßa b·∫°n"
                    id="cityInput"
                  />
                  <button className="add-newcity">Xem th·ªùi ti·∫øt</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Weathers />);
    </script>
  </body>
</html>
